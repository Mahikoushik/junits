package com.eaton.platform.core.workflows;

import com.adobe.granite.workflow.WorkflowSession;
import com.adobe.granite.workflow.exec.WorkItem;
import com.adobe.granite.workflow.metadata.MetaDataMap;
import io.wcm.testing.mock.aem.junit5.AemContext;
import io.wcm.testing.mock.aem.junit5.AemContextExtension;
import org.apache.sling.api.resource.Resource;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;

import static org.junit.jupiter.api.Assertions.assertEquals;

@ExtendWith(AemContextExtension.class)
class EPSDensityDeciderTest {

    private final AemContext context = new AemContext();
    private EPSDensityDecider epsDensityDecider;

    private static final String TEST_ASSET_PATH = "/content/dam/test-asset";
    private static final String TEST_METADATA_PATH = TEST_ASSET_PATH + "/jcr:content/metadata";

    @BeforeEach
    void setUp() {
        epsDensityDecider = new EPSDensityDecider();

        // Create asset and metadata structure
        context.create().resource(TEST_METADATA_PATH, "xmp:eaton-content-type", "eaton:resources/technical-resources/drawings");
    }

    @Test
    void testExecute_Density1000() throws Exception {
        // Simulate a WorkItem and WorkflowSession
        WorkItem workItem = context.create().resource("/var/workflow/item").adaptTo(WorkItem.class);
        WorkflowSession workflowSession = context.create().resource("/var/workflow/session").adaptTo(WorkflowSession.class);

        // Create MetaDataMap
        MetaDataMap metaDataMap = context.create().resource("/var/workflow/metaDataMap").adaptTo(MetaDataMap.class);

        // Execute the workflow process
        epsDensityDecider.execute(workItem, workflowSession, metaDataMap);

        // Validate the density decision
        assertEquals(EPSDensityDecider.DENSITY_1000, metaDataMap.get(EPSDensityDecider.DENSITY_DECISION));
    }

    @Test
    void testExecute_Density300() throws Exception {
        // Update content type to simulate a different asset type
        Resource metadataResource = context.resourceResolver().getResource(TEST_METADATA_PATH);
        assert metadataResource != null;
        metadataResource.adaptTo(javax.jcr.Node.class).setProperty("xmp:eaton-content-type", "eaton:resources/marketing-resources/illustrations");

        // Simulate a WorkItem and WorkflowSession
        WorkItem workItem = context.create().resource("/var/workflow/item").adaptTo(WorkItem.class);
        WorkflowSession workflowSession = context.create().resource("/var/workflow/session").adaptTo(WorkflowSession.class);

        // Create MetaDataMap
        MetaDataMap metaDataMap = context.create().resource("/var/workflow/metaDataMap").adaptTo(MetaDataMap.class);

        // Execute the workflow process
        epsDensityDecider.execute(workItem, workflowSession, metaDataMap);

        // Validate the density decision
        assertEquals(EPSDensityDecider.DENSITY_300, metaDataMap.get(EPSDensityDecider.DENSITY_DECISION));
    }
}
